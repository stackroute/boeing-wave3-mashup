version: "2.1"
services:

  apigateway:
    image: zuul-service
    build: zuul-gatewayservice/
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      - eurekaserver
    ports:
      - 8092:8092
    healthcheck:
      test: "exit 0"

  eurekaserver:
    image: eureka-service:latest
    build: eureka-server/
    restart: always
    network_mode: host
    hostname: localhost
    ports:
      - 8093:8093
    healthcheck:
      test: "exit 0"

  mongo:
    image: mongo:3.4-jessie
    ports:
      - 27017:27017
    container_name: mongo_docker
    network_mode: host
    hostname: localhost
    restart: always
    volumes:
      - /DB/mongo:/data/db
    healthcheck:
      test: "exit 0"

  neo4j:
    image: neo4j:latest
    ports:
      - 7474:7474
      - 7687:7687
    container_name: neo4j_docker
    network_mode: host
    hostname: localhost
    restart: always
    volumes:
      - /DB/neo4j:/data/db
    healthcheck:
      test: "exit 0"

  mysql:
    image: mysql:5.7
    ports:
      - 3306:3306
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: springbootdb
      MYSQL_PASSWORD: root
      MYSQL_USER: root
    network_mode: "host"
    hostname: localhost
    restart: always
    volumes:
      - /DB/mysql:/var/lib/mysql
    healthcheck:
      test: "exit 0"

  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    network_mode: "host"
    hostname: localhost
    ports:
      - 2181:2181
    restart: always
    healthcheck:
      test: "exit 0"

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    network_mode: "host"
    hostname: localhost
    ports:
      - 9092:9092
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_ZOOKEEPER_CONNECT: 'localhost:2181'
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_CREATE_TOPICS: "AuthMessage, QuestionMessage"
    restart: always
    healthcheck:
      test: "exit 0"

  registration-service:
    image: registration-service
    build: ./registration-service/
    container_name: reg_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      mongo:
        condition: service_healthy
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - 8020:8020
    healthcheck:
      test: "exit 0"

  authentication-service:
    image: authentication-service
    build: ./authentication-service/
    container_name: auth_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      mysql:
        condition: service_healthy
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - 8021:8021
    healthcheck:
      test: "exit 0"

  question-service:
    image: question-service
    build: ./question-service/
    container_name: qp_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      mongo:
        condition: service_healthy
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - 8022:8022
    healthcheck:
      test: "exit 0"

  recommendation-service:
    image: recommendation-service
    build: ./recommendation-service/
    container_name: rs_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      neo4j:
        condition: service_healthy
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - 8023:8023
    healthcheck:
      test: "exit 0"

  userprofile-service:
    image: userprofile-service
    build: ./userprofile-service/
    container_name: up_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      mongo:
        condition: service_healthy
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - 8024:8024
    healthcheck:
      test: "exit 0"

  execution-engine:
    image: execution-engine
    build: ./execution-engine/
    container_name: exec_docker
    restart: always
    network_mode: host
    hostname: localhost
    depends_on:
      apigateway:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
    ports:
      - 8025:8025
    healthcheck:
      test: "exit 0"
